name: Deploy to Production

on:
  push:
    branches:
      - production
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        env:
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
        run: npm run build

      - name: Create deployment archive
        run: |
          cd dist
          tar -czvf ../deploy.tar.gz .

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy.tar.gz"
          target: "/home/jesse"

      - name: Extract and setup on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /home/jesse

            echo "========================================="
            echo "1. 設置網站目錄..."
            echo "========================================="

            # 建立網站目錄
            sudo mkdir -p /var/www/jesse-chen.com
            sudo chown jesse:jesse /var/www/jesse-chen.com

            # 清空並解壓
            rm -rf /var/www/jesse-chen.com/*
            tar -xzvf deploy.tar.gz -C /var/www/jesse-chen.com

            # 清理
            rm deploy.tar.gz

            echo "========================================="
            echo "2. 配置 Nginx..."
            echo "========================================="

            # 停止 Docker 容器（如果存在）
            cd /home/jesse/heart-whisper-town 2>/dev/null && docker compose -f docker-compose.production-prebuilt.yml down 2>/dev/null || true

            # 檢查 nginx 是否安裝
            if ! command -v nginx &> /dev/null; then
                echo "安裝 Nginx..."
                sudo apt-get update
                sudo apt-get install -y nginx
            fi

            # 確保 sites-available 和 sites-enabled 目錄存在
            sudo mkdir -p /etc/nginx/sites-available
            sudo mkdir -p /etc/nginx/sites-enabled

            # 確保 nginx.conf 包含 sites-enabled
            if ! grep -q "sites-enabled" /etc/nginx/nginx.conf; then
                echo "配置 nginx.conf 以包含 sites-enabled..."
                sudo sed -i '/http {/a \    include /etc/nginx/sites-enabled/*;' /etc/nginx/nginx.conf
            fi

            # 建立 nginx 配置
            printf '%s\n' 'server {' '    listen 80;' '    server_name jesse-chen.com www.jesse-chen.com;' '    root /var/www/jesse-chen.com;' '    index index.html;' '    gzip on;' '    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;' '    location / {' '        try_files $uri $uri/ /index.html;' '    }' '    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {' '        expires 1y;' '        add_header Cache-Control "public, immutable";' '    }' '}' | sudo tee /etc/nginx/sites-available/jesse-chen.com > /dev/null

            # 啟用網站
            sudo ln -sf /etc/nginx/sites-available/jesse-chen.com /etc/nginx/sites-enabled/

            # 移除預設配置（如果存在）
            sudo rm -f /etc/nginx/sites-enabled/default

            # 顯示生成的配置
            echo "========================================="
            echo "Nginx 配置內容:"
            echo "========================================="
            cat /etc/nginx/sites-available/jesse-chen.com

            # 測試 nginx 配置
            echo "========================================="
            echo "測試 Nginx 配置:"
            echo "========================================="
            sudo nginx -t

            # 啟用並重啟 nginx
            sudo systemctl enable nginx
            sudo systemctl stop nginx || true
            sudo systemctl start nginx

            # 確認 nginx 運行狀態
            echo "========================================="
            echo "Nginx 狀態:"
            echo "========================================="
            sudo systemctl status nginx --no-pager || true

            # 檢查端口監聽
            echo "========================================="
            echo "端口 80 監聽狀態:"
            echo "========================================="
            sudo ss -tlnp | grep :80 || echo "沒有服務監聽端口 80"

            echo "========================================="
            echo "3. 部署完成！"
            echo "========================================="
            ls -la /var/www/jesse-chen.com/
