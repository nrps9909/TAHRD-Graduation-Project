name: Build, Test and Deploy to Production (Optimized)

on:
  push:
    branches:
      - production
  pull_request:
    branches:
      - production

permissions:
  contents: read
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: nrps9909/tahrd-graduation-project

jobs:
  # ç¬¬ä¸€éšæ®µï¼šæ¸¬è©¦å’Œé©—è­‰ï¼ˆä¸¦è¡ŒåŸ·è¡Œï¼‰
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [backend, frontend]
      fail-fast: false # è®“å…©å€‹éƒ½åŸ·è¡Œå®Œï¼Œå³ä½¿ä¸€å€‹å¤±æ•—

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies (Workspaces)
        run: npm install

      - name: Lint ${{ matrix.component }}
        run: |
          cd ${{ matrix.component }}
          npm run lint || echo "âš ï¸ No lint script found for ${{ matrix.component }}"

      - name: Type Check ${{ matrix.component }}
        run: |
          cd ${{ matrix.component }}
          timeout 5m npx tsc --noEmit || echo "âš ï¸ Type check timed out or failed"

      - name: Test ${{ matrix.component }}
        run: |
          cd ${{ matrix.component }}
          npm test || echo "âš ï¸ No tests found for ${{ matrix.component }}"

  # é©—è­‰é…ç½®æ–‡ä»¶
  validate-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Docker Compose
        run: |
          # å‰µå»ºè‡¨æ™‚ .env.production ç”¨æ–¼é©—è­‰ï¼ˆä¸å«æ•æ„Ÿä¿¡æ¯ï¼‰
          cat > .env.production << EOF
          NODE_ENV=production
          PORT=4000
          FRONTEND_PORT=3000
          DATABASE_URL="mongodb://localhost:27017/test"
          REDIS_URL=redis://redis:6379
          REDIS_HOST=redis
          REDIS_PORT=6379
          JWT_SECRET=test_secret
          GEMINI_API_KEY=test_key
          FRONTEND_URL=https://example.com
          EOF

          docker compose -f docker-compose.production-prebuilt.yml config > /dev/null
          echo "âœ… Docker Compose é…ç½®é©—è­‰é€šé"

      - name: Validate Nginx Config
        run: |
          if grep -r "upstream backend" nginx/conf.d/*.conf | wc -l | grep -q "^[2-9]"; then
            echo "âŒ éŒ¯èª¤ï¼šç™¼ç¾é‡è¤‡çš„ upstream backend å®šç¾©"
            grep -n "upstream backend" nginx/conf.d/*.conf
            exit 1
          fi
          echo "âœ… Nginx é…ç½®æª¢æŸ¥é€šé"

  # ç¬¬äºŒéšæ®µï¼šæ§‹å»ºå’Œæ¨é€æ˜ åƒï¼ˆä¸¦è¡Œæ§‹å»ºï¼‰
  build-and-push:
    needs: [test, validate-config]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    strategy:
      matrix:
        component: [backend, frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for ${{ matrix.component }}
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.component }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-
            type=raw,value={{date 'YYYYMMDD-HHmmss'}}

      - name: Build and push ${{ matrix.component }} image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.component }}
          file: ./${{ matrix.component }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.component }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.component }}:buildcache,mode=max
          build-args: |
            VITE_BACKEND_URL=${{ matrix.component == 'frontend' && 'https://jesse-chen.com' || '' }}
            VITE_GRAPHQL_URL=${{ matrix.component == 'frontend' && 'https://jesse-chen.com/graphql' || '' }}
            VITE_API_URL=${{ matrix.component == 'frontend' && 'https://jesse-chen.com/api' || '' }}
            VITE_WS_URL=${{ matrix.component == 'frontend' && 'wss://jesse-chen.com/socket.io' || '' }}
            VITE_GEMINI_API_KEY=${{ matrix.component == 'frontend' && secrets.VITE_GEMINI_API_KEY || '' }}
            VITE_OPENWEATHER_API_KEY=${{ matrix.component == 'frontend' && secrets.VITE_OPENWEATHER_API_KEY || '' }}
            VITE_DEBUG=${{ matrix.component == 'frontend' && 'false' || '' }}

  # ç¬¬ä¸‰éšæ®µï¼šéƒ¨ç½²ï¼ˆå¸¶æœ‰å›æ»¾æ©Ÿåˆ¶ï¼‰
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        env:
          GITHUB_REPOSITORY: ${{ env.IMAGE_NAME }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: GITHUB_REPOSITORY
          script_stop: true
          script: |
            set -e

            cd /home/jesse/heart-whisper-town

            echo "========================================="
            echo "ğŸš€ é–‹å§‹éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ"
            echo "æ™‚é–“: $(date)"
            echo "========================================="

            # 1. å‚™ä»½ç•¶å‰ç‰ˆæœ¬ï¼ˆç”¨æ–¼å›æ»¾ï¼‰
            echo "ğŸ“¦ å‚™ä»½ç•¶å‰ç‰ˆæœ¬..."
            BACKUP_TAG="backup-$(date +%Y%m%d-%H%M%S)"
            docker tag ghcr.io/${GITHUB_REPOSITORY}/backend:latest ghcr.io/${GITHUB_REPOSITORY}/backend:${BACKUP_TAG} 2>/dev/null || true
            docker tag ghcr.io/${GITHUB_REPOSITORY}/frontend:latest ghcr.io/${GITHUB_REPOSITORY}/frontend:${BACKUP_TAG} 2>/dev/null || true
            echo "backup_tag=${BACKUP_TAG}" > /tmp/deployment_backup.txt

            # 2. æ‹‰å–æœ€æ–°ä»£ç¢¼
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç¢¼..."
            git fetch origin
            PREVIOUS_COMMIT=$(git rev-parse HEAD)
            git reset --hard origin/production
            echo "previous_commit=${PREVIOUS_COMMIT}" >> /tmp/deployment_backup.txt

            # 3. æ‹‰å–æœ€æ–°æ˜ åƒ
            echo "ğŸ³ æ‹‰å–æœ€æ–° Docker æ˜ åƒ..."
            # æ˜ åƒåç¨±å·²åœ¨ docker-compose.production-prebuilt.yml ä¸­ç¡¬ç·¨ç¢¼ç‚ºå°å¯«
            if ! docker compose -f docker-compose.production-prebuilt.yml pull; then
              echo "âŒ æ‹‰å–æ˜ åƒå¤±æ•—ï¼"
              exit 1
            fi

            # 4. é‡æ–°å‰µå»ºå®¹å™¨
            echo "ğŸ”„ é‡æ–°å‰µå»ºå®¹å™¨..."
            if ! docker compose -f docker-compose.production-prebuilt.yml up -d --force-recreate; then
              echo "âŒ å®¹å™¨å•Ÿå‹•å¤±æ•—ï¼"
              echo "ğŸ“‹ æŸ¥çœ‹å®¹å™¨ç‹€æ…‹ï¼š"
              docker compose -f docker-compose.production-prebuilt.yml ps -a
              echo ""
              echo "ğŸ“‹ å¾Œç«¯æ—¥èªŒï¼š"
              docker compose -f docker-compose.production-prebuilt.yml logs --tail=100 backend
              exit 1
            fi

            # 5. ç­‰å¾…æœå‹™å•Ÿå‹•ä¸¦ç›£æ§å®¹å™¨ç‹€æ…‹
            echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•..."
            sleep 10

            # æª¢æŸ¥å®¹å™¨æ˜¯å¦é‚„åœ¨é‹è¡Œ
            echo "ğŸ” æª¢æŸ¥å®¹å™¨ç‹€æ…‹..."
            BACKEND_STATUS=$(docker inspect -f '{{.State.Status}}' heart-whisper-backend 2>/dev/null || echo "not_found")
            if [ "$BACKEND_STATUS" != "running" ]; then
              echo "âŒ å¾Œç«¯å®¹å™¨æœªé‹è¡Œï¼ç‹€æ…‹: $BACKEND_STATUS"
              echo "ğŸ“‹ å®¹å™¨è©³ç´°ä¿¡æ¯ï¼š"
              docker inspect heart-whisper-backend 2>/dev/null || echo "ç„¡æ³•ç²å–å®¹å™¨ä¿¡æ¯"
              echo ""
              echo "ğŸ“‹ å¾Œç«¯æ—¥èªŒï¼š"
              docker compose -f docker-compose.production-prebuilt.yml logs --tail=100 backend
              echo ""
              echo "ğŸ“‹ ç³»çµ±è³‡æºä½¿ç”¨æƒ…æ³ï¼š"
              free -h
              docker stats --no-stream
              exit 1
            fi
            echo "âœ… å¾Œç«¯å®¹å™¨æ­£åœ¨é‹è¡Œ"

            # 6. å¥åº·æª¢æŸ¥
            echo "ğŸ¥ åŸ·è¡Œå¥åº·æª¢æŸ¥..."

            MAX_RETRIES=6
            RETRY_COUNT=0
            BACKEND_HEALTHY=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "å˜—è©¦ $RETRY_COUNT/$MAX_RETRIES..."

              # å†æ¬¡æª¢æŸ¥å®¹å™¨æ˜¯å¦é‚„åœ¨é‹è¡Œ
              BACKEND_STATUS=$(docker inspect -f '{{.State.Status}}' heart-whisper-backend 2>/dev/null || echo "not_found")
              if [ "$BACKEND_STATUS" != "running" ]; then
                echo "âŒ å¾Œç«¯å®¹å™¨åœ¨å¥åº·æª¢æŸ¥æœŸé–“åœæ­¢äº†ï¼"
                echo "ğŸ“‹ å¾Œç«¯æ—¥èªŒï¼š"
                docker compose -f docker-compose.production-prebuilt.yml logs --tail=100 backend
                exit 1
              fi

              # æª¢æŸ¥å¾Œç«¯å¥åº·
              if curl -f -s http://localhost/health > /dev/null; then
                echo "âœ… å¾Œç«¯å¥åº·æª¢æŸ¥é€šé"
                BACKEND_HEALTHY=true
                break
              else
                echo "âš ï¸ å¾Œç«¯å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œç­‰å¾… 10 ç§’å¾Œé‡è©¦..."
                sleep 10
              fi
            done

            if [ "$BACKEND_HEALTHY" = false ]; then
              echo "âŒ å¾Œç«¯å¥åº·æª¢æŸ¥å¤±æ•—ï¼"
              echo "ğŸ“‹ å¾Œç«¯æ—¥èªŒï¼š"
              docker compose -f docker-compose.production-prebuilt.yml logs --tail=100 backend
              echo ""
              echo "ğŸ“‹ Nginx æ—¥èªŒï¼š"
              docker compose -f docker-compose.production-prebuilt.yml logs --tail=50 nginx
              exit 1
            fi

            # æª¢æŸ¥ GraphQL
            if ! curl -f -s -X POST http://localhost/graphql \
                -H "Content-Type: application/json" \
                -d '{"query":"{__typename}"}' > /dev/null; then
              echo "âŒ GraphQL å¥åº·æª¢æŸ¥å¤±æ•—ï¼"
              docker compose -f docker-compose.production-prebuilt.yml logs --tail=50 backend
              exit 1
            fi
            echo "âœ… GraphQL å¥åº·æª¢æŸ¥é€šé"

            # 7. æ¸…ç†èˆŠæ˜ åƒ
            echo "ğŸ§¹ æ¸…ç†èˆŠæ˜ åƒ..."
            docker image prune -f

            echo "========================================="
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "æ™‚é–“: $(date)"
            echo "========================================="
            echo ""
            echo "ğŸ“Š æœå‹™ç‹€æ…‹ï¼š"
            docker compose -f docker-compose.production-prebuilt.yml ps

      # éƒ¨ç½²å¤±æ•—æ™‚è‡ªå‹•å›æ»¾
      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "========================================="
            echo "âš ï¸ éƒ¨ç½²å¤±æ•—ï¼Œé–‹å§‹è‡ªå‹•å›æ»¾"
            echo "========================================="

            cd /home/jesse/heart-whisper-town

            # è®€å–å‚™ä»½ä¿¡æ¯
            if [ -f /tmp/deployment_backup.txt ]; then
              source /tmp/deployment_backup.txt

              # å›æ»¾ä»£ç¢¼
              if [ -n "$previous_commit" ]; then
                echo "ğŸ“¥ å›æ»¾ä»£ç¢¼åˆ° ${previous_commit}"
                git reset --hard ${previous_commit}
              fi

              # å›æ»¾å®¹å™¨
              echo "ğŸ”„ é‡å•Ÿæœå‹™..."
              docker compose -f docker-compose.production-prebuilt.yml up -d --force-recreate

              echo "âœ… å›æ»¾å®Œæˆ"
            else
              echo "âš ï¸ æ‰¾ä¸åˆ°å‚™ä»½ä¿¡æ¯ï¼Œè«‹æ‰‹å‹•æª¢æŸ¥"
            fi

            echo ""
            echo "ğŸ“Š ç•¶å‰æœå‹™ç‹€æ…‹ï¼š"
            docker compose -f docker-compose.production-prebuilt.yml ps

            echo ""
            echo "ğŸ“‹ æœ€è¿‘çš„æ—¥èªŒï¼š"
            docker compose -f docker-compose.production-prebuilt.yml logs --tail=50

      # éƒ¨ç½²ç‹€æ…‹é€šçŸ¥
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "ç’°å¢ƒ: Production"
            echo "åˆ†æ”¯: ${{ github.ref_name }}"
            echo "æäº¤: ${{ github.sha }}"
            echo "éƒ¨ç½²è€…: ${{ github.actor }}"
          else
            echo "âŒ éƒ¨ç½²å¤±æ•—ï¼å·²åŸ·è¡Œè‡ªå‹•å›æ»¾"
            echo "ç’°å¢ƒ: Production"
            echo "åˆ†æ”¯: ${{ github.ref_name }}"
            echo "æäº¤: ${{ github.sha }}"
            echo "éƒ¨ç½²è€…: ${{ github.actor }}"
            echo "è«‹æª¢æŸ¥æ—¥èªŒä¸¦æ‰‹å‹•ä¿®å¾©"
          fi
