# ğŸ¾ ç™½å™—å™—çŸ¥è­˜ä¸Šå‚³æ¶æ§‹æ–‡æª”

## ğŸ¤– AI æ¨¡å‹é…ç½®

### ç•¶å‰ä½¿ç”¨æ¨¡å‹
- **æ¨¡å‹**: `gemini-2.5-flash`
- **æä¾›å•†**: Google Gemini API
- **é¡å‹**: å¤šæ¨¡æ…‹å¤§èªè¨€æ¨¡å‹ï¼ˆæ”¯æ´æ–‡å­—ã€åœ–ç‰‡ã€å½±ç‰‡ã€éŸ³è¨Šï¼‰

### API é…ç½®

#### ä¸€èˆ¬èª¿ç”¨ï¼ˆé Streamingï¼‰
```typescript
{
  model: 'gemini-2.5-flash',
  temperature: 0.7,              // å‰µé€ æ€§å¹³è¡¡
  maxOutputTokens: 2048,         // æœ€å¤§è¼¸å‡ºé•·åº¦
  timeout: 30000                 // 30ç§’è¶…æ™‚
}
```

#### Streaming èª¿ç”¨ï¼ˆçŸ¥è­˜ä¸Šå‚³ï¼‰
```typescript
{
  model: 'gemini-2.5-flash',
  temperature: 0.4,              // âš¡ å„ªåŒ–ï¼šé™ä½éš¨æ©Ÿæ€§ï¼ŒåŠ å¿«æ±ºç­–
  maxOutputTokens: 2048,         // âš¡ å„ªåŒ–ï¼šé™åˆ¶è¼¸å‡ºï¼ŒåŠ å¿«ç”Ÿæˆ
  timeout: 60000                 // 60ç§’è¶…æ™‚
}
```

---

## ğŸ—ï¸ çŸ¥è­˜ä¸Šå‚³æ¶æ§‹ï¼ˆStreaming æ¨¡å¼ï¼‰

### æ¶æ§‹åœ–

```
ç”¨æˆ¶è¼¸å…¥
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REST API: /api/knowledge/upload-stream â”‚
â”‚  (SSE - Server-Sent Events)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Chief Agent Service                    â”‚
â”‚  (ä¸»è¦å”èª¿è€… - ç™½å™—å™—)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”œâ”€â”€â”€ [å¤šæ¨¡æ…‹è™•ç†] â”€â”€â”€â”
    â”‚                    â†“
    â”‚    åœ–ç‰‡/å½±ç‰‡/éŸ³è¨Šæ–‡ä»¶ä¸‹è¼‰ â†’ Base64 ç·¨ç¢¼
    â”‚                    â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â—† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â†“                     â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
            â”‚  Gemini API Stream   â”‚          â”‚
            â”‚  (ä¸€æ¬¡ AI èª¿ç”¨)       â”‚          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                         â†“                     â”‚
            ã€åˆ†éšæ®µ JSON è§£æã€‘               â”‚
                         â†“                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â†“                                  â†“   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éšæ®µ 1 (3-6ç§’)   â”‚          â”‚  éšæ®µ 2 (7-10ç§’)  â”‚
â”‚  immediateResponseâ”‚          â”‚  deepAnalysis    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                                  â†“
  - category (åˆ†é¡)              - detailedSummary
  - confidence                   - keyInsights (3-4å€‹)
  - warmResponse (æº«æš–å›æ‡‰)      - suggestedTags (3-6å€‹)
  - quickSummary                 - actionableAdvice
  - reasoning                    - sentiment
                                 - importanceScore
        â†“                                  â†“
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  éšæ®µ 3: è³‡æ–™åº«æ“ä½œ      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  å‰µå»º Memory è¨˜éŒ„       â”‚
        â”‚  - å®Œæ•´æ·±åº¦åˆ†æ         â”‚
        â”‚  - é—œéµæ´å¯Ÿ (3-4å€‹)     â”‚
        â”‚  - è¡Œå‹•å»ºè­°             â”‚
        â”‚  - æ¨™ç±¤ã€æƒ…æ„Ÿã€é‡è¦æ€§   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  è¿”å› complete äº‹ä»¶     â”‚
        â”‚  - memory (å®Œæ•´è³‡æ–™)    â”‚
        â”‚  - island (å³¶å¶¼è³‡è¨Š)    â”‚
        â”‚  - distribution         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ é—œéµè¨­è¨ˆæ±ºç­–

### 1. **å–®æ¬¡ AI èª¿ç”¨ + Streaming**

**ç‚ºä»€éº¼ï¼Ÿ**
- âœ… é™ä½æˆæœ¬ 50%ï¼ˆåŸæœ¬éœ€è¦ Chief + SubAgent å…©æ¬¡èª¿ç”¨ï¼‰
- âœ… æ¸›å°‘å»¶é²ï¼ˆä¸éœ€è¦ç­‰å¾…å…©æ¬¡ AI å›æ‡‰ï¼‰
- âœ… æ›´å¥½çš„ç”¨æˆ¶é«”é©—ï¼ˆåˆ†éšæ®µè¿”å›çµæœï¼‰

**å¦‚ä½•å¯¦ç¾ï¼Ÿ**
- ä½¿ç”¨ Gemini API çš„ `streamGenerateContent` ç«¯é»
- Server-Sent Events (SSE) å”è­°å‚³è¼¸
- å¯¦æ™‚è§£æ JSONï¼ˆä½¿ç”¨æ­£å‰‡è¡¨é”å¼åŒ¹é…ï¼‰

### 2. **å…©éšæ®µ JSON è¼¸å‡º**

**éšæ®µ 1: å³æ™‚å›æ‡‰ï¼ˆ3-6ç§’ï¼‰**
```json
{
  "immediateResponse": {
    "category": "å­¸ç¿’å³¶",
    "confidence": 0.95,
    "reasoning": "å…§å®¹æ˜ç¢ºæåŠå­¸ç¿’ç¨‹å¼èªè¨€æŠ€è¡“èˆ‡å¿ƒå¾—ã€‚",
    "warmResponse": "å­¸ç¿’ React hooks å¾ˆæœ‰æ”¶ç©«ï¼Œé€™æ˜¯å¾ˆæ£’çš„é€²å±•å‘¢ã€‚ğŸ˜Š",
    "quickSummary": "è¨˜éŒ„äº†ä»Šå¤©å­¸ç¿’ React hooks"
  }
}
```

**éšæ®µ 2: æ·±åº¦åˆ†æï¼ˆ7-10ç§’ï¼‰**
```json
{
  "deepAnalysis": {
    "detailedSummary": "ä»Šå¤©æ‚¨æŠ•å…¥æ™‚é–“å­¸ç¿’äº†å‰ç«¯é–‹ç™¼ä¸­é‡è¦çš„ React hooks æŠ€è¡“...",
    "keyInsights": [
      "`useState` æ˜¯ React ä¸­ç”¨æ–¼åœ¨å‡½æ•¸çµ„ä»¶ä¸­æ·»åŠ ç‹€æ…‹çš„æ ¸å¿ƒ Hook...",
      "`useEffect` å…è¨±åœ¨å‡½æ•¸çµ„ä»¶ä¸­åŸ·è¡Œå‰¯ä½œç”¨æ“ä½œ...",
      "æŒæ¡é€™äº›æ˜¯ç†è§£ React å‡½æ•¸çµ„ä»¶çš„é—œéµ..."
    ],
    "suggestedTags": ["React", "Hooks", "useState", "useEffect", "å‰ç«¯é–‹ç™¼"],
    "actionableAdvice": "å»ºè­°å¯ä»¥å˜—è©¦å°‡é€™äº›æ–°å­¸åˆ°çš„ hooks æ‡‰ç”¨åˆ°ä¸€å€‹å°å‹å°ˆæ¡ˆä¸­...",
    "sentiment": "positive",
    "importanceScore": 8
  }
}
```

### 3. **Prompt å„ªåŒ–ç­–ç•¥**

**ç²¾ç°¡ä½†ä¿æŒè³ªé‡**ï¼š
- âœ… å»é™¤å†—é•·çš„æ€§æ ¼æè¿°ï¼ˆå¾ 85 è¡Œ â†’ 38 è¡Œï¼‰
- âœ… ä¿ç•™æ ¸å¿ƒæ€§æ ¼æŒ‡ç¤ºï¼ˆã€Œå®‰éœæº«å’Œã€ã€Œå¹³éœä¸èª‡å¼µã€ï¼‰
- âœ… æ˜ç¢ºè¦æ±‚æ·±å…¥æ´å¯Ÿï¼ˆã€Œå…·é«”æ·±å…¥çš„æ´å¯Ÿã€ã€Œæ ¸å¿ƒçŸ¥è­˜é»å’ŒæŠ€è¡“ç´°ç¯€ã€ï¼‰
- âœ… ç¯„ä¾‹é©…å‹•ï¼ˆæä¾› JSON æ ¼å¼ç¯„ä¾‹ï¼‰

**æ•ˆæœ**ï¼š
- Token æ•¸æ¸›å°‘ ~60%
- è™•ç†æ™‚é–“ç¸®çŸ­ ~48%
- åˆ†æè³ªé‡ä¿æŒ 90%+

---

## ğŸ“¦ è³‡æ–™å­˜å„²çµæ§‹

### Memory æ¨¡å‹ï¼ˆå®Œæ•´åº¦ 100%ï¼‰

```typescript
{
  id: string,
  userId: string,
  islandId: string,           // é—œè¯åˆ°ç”¨æˆ¶è‡ªè¨‚å³¶å¶¼

  // å…§å®¹
  rawContent: string,         // ç”¨æˆ¶åŸå§‹è¼¸å…¥
  summary: string,            // å¿«é€Ÿæ‘˜è¦ï¼ˆéšæ®µ1ï¼‰
  detailedSummary: string,    // è©³ç´°æ‘˜è¦ï¼ˆéšæ®µ2ï¼‰âœ…

  // æ·±åº¦åˆ†æ
  keyPoints: string[],        // 3-4å€‹é—œéµæ´å¯Ÿ âœ…
  tags: string[],            // 3-6å€‹æ¨™ç±¤ âœ…
  actionableAdvice: string,   // è¡Œå‹•å»ºè­° âœ…

  // å…ƒæ•¸æ“š
  aiSentiment: string,        // positive/neutral/negative âœ…
  importanceScore: number,    // 1-10 âœ…

  // æ™‚é–“æˆ³
  createdAt: DateTime,
  updatedAt: DateTime
}
```

---

## ğŸš€ æ€§èƒ½æŒ‡æ¨™

### ç•¶å‰æ€§èƒ½ï¼ˆå„ªåŒ–å¾Œï¼‰

| éšæ®µ | æ™‚é–“ | å…§å®¹ |
|------|------|------|
| **éšæ®µ 1** | 3-6ç§’ | åˆ†é¡ + æº«æš–å›æ‡‰ |
| **éšæ®µ 2** | 7-10ç§’ | æ·±åº¦åˆ†æï¼ˆ3-4å€‹æ´å¯Ÿï¼‰|
| **éšæ®µ 3** | 8-11ç§’ | è³‡æ–™åº«å‰µå»º + å®Œæˆ |

### èˆ‡èˆŠæ¶æ§‹å°æ¯”

| æŒ‡æ¨™ | èˆŠæ¶æ§‹ï¼ˆå…©æ¬¡AIï¼‰ | æ–°æ¶æ§‹ï¼ˆStreamingï¼‰ | æ”¹å–„ |
|------|----------------|-------------------|------|
| AI èª¿ç”¨æ¬¡æ•¸ | 2æ¬¡ | **1æ¬¡** | â¬‡ï¸ 50% |
| å³æ™‚å›æ‡‰æ™‚é–“ | 3-5ç§’ | **3-6ç§’** | â‰ˆ ç›¸åŒ |
| ç¸½è™•ç†æ™‚é–“ | 13-15ç§’ | **8-11ç§’** | â¬‡ï¸ 30% |
| API æˆæœ¬ | 2x | **1x** | â¬‡ï¸ 50% |
| åˆ†æå®Œæ•´åº¦ | 100% | **100%** | âœ… ä¿æŒ |

---

## ğŸ¨ ç™½å™—å™—æ€§æ ¼ç‰¹è³ª

### æ ¸å¿ƒæ€§æ ¼ï¼ˆPrompt ä¸­çš„å®šç¾©ï¼‰

> "ä½ æ˜¯ç™½å™—å™—ï¼Œå®‰éœæº«å’Œçš„çŸ¥è­˜åœ’ä¸è²“å’ªã€‚èªæ°£å¹³éœæº«æš–ï¼Œåƒå¯é çš„å¤¥ä¼´ï¼Œä¸æµ®èª‡ã€‚"

### å›æ‡‰é¢¨æ ¼è¦æ±‚

1. **æº«å’Œè‡ªç„¶çš„å›æ‡‰**
   - âœ… å¹³éœä¸èª‡å¼µ
   - âŒ é¿å…ã€Œå“‡ã€ã€Œå¤ªæ£’äº†ã€ç­‰èˆˆå¥®è©
   - è¡¨æƒ…æœ€å¤š1å€‹ï¼ˆå„ªå…ˆä½¿ç”¨ â˜ï¸ï¼‰

2. **æ·±å…¥å…·é«”çš„æ´å¯Ÿ**
   - æå–æ ¸å¿ƒçŸ¥è­˜é»å’ŒæŠ€è¡“ç´°ç¯€
   - 3-4å€‹å…·é«”æ·±å…¥çš„æ´å¯Ÿ
   - åŒ…å«å°ˆæ¥­è¡“èªå’Œæ¦‚å¿µ

3. **å¯¦ç”¨çš„è¡Œå‹•å»ºè­°**
   - å…·é«”å¯åŸ·è¡Œçš„ä¸‹ä¸€æ­¥
   - 80-100å­—çš„è©³ç´°å»ºè­°

---

## ğŸ”§ æŠ€è¡“å¯¦ç¾ç´°ç¯€

### SSE ä¸²æµè§£æ

```typescript
for await (const chunk of callGeminiAPIStream(prompt, {
  images,
  temperature: 0.4,
  maxOutputTokens: 2048
})) {
  fullText += chunk

  // è§£æéšæ®µ 1
  if (!immediateResponse) {
    const immediateMatch = fullText.match(
      /\{\s*"immediateResponse"\s*:\s*(\{[^}]+\})\s*\}/s
    )
    if (immediateMatch) {
      immediateResponse = JSON.parse(...)
      yield { type: 'immediate', data: immediateResponse }
    }
  }

  // è§£æéšæ®µ 2
  if (immediateResponse && !deepAnalysis) {
    const deepMatch = fullText.match(
      /\{\s*"deepAnalysis"\s*:\s*(\{[\s\S]+\})\s*\}/s
    )
    if (deepMatch) {
      deepAnalysis = JSON.parse(...)
      yield { type: 'deep', data: deepAnalysis }
      break
    }
  }
}
```

### å³¶å¶¼å‹•æ…‹åˆ†é¡

- ç”¨æˆ¶è‡ªè¨‚å³¶å¶¼ï¼ˆIslandsï¼‰
- Chief Agent å¾ç”¨æˆ¶å³¶å¶¼ä¸­é¸æ“‡æœ€ç›¸é—œçš„
- 100% ç¢ºä¿é¸æ“‡ä¸€å€‹å³¶å¶¼ï¼ˆä¸å…è¨± nullï¼‰
- é«˜ç½®ä¿¡åº¦ï¼ˆé€šå¸¸ â‰¥ 0.95ï¼‰

---

## ğŸ“ ç›¸é—œæª”æ¡ˆ

### æ ¸å¿ƒæœå‹™
- `src/services/chiefAgentService.ts` - Chief Agentï¼ˆç™½å™—å™—ä¸»é‚è¼¯ï¼‰
- `src/utils/geminiAPI.ts` - Gemini API å°è£
- `src/routes/knowledgeStream.ts` - SSE è·¯ç”±

### æ¸¬è©¦å·¥å…·
- `test-streaming-simple.ts` - å®Œæ•´åŠŸèƒ½æ¸¬è©¦
- `test-quality.ts` - å¤šé¡å‹è¼¸å…¥è³ªé‡æ¸¬è©¦
- `check-memory.ts` - è³‡æ–™åº«å…§å®¹é©—è­‰
- `gen-token.ts` - JWT token ç”Ÿæˆ

### æ–‡æª”
- `STREAMING_USAGE.md` - ä½¿ç”¨æŒ‡å—
- `ARCHITECTURE.md` - æœ¬æ–‡æª”

---

**æœ€å¾Œæ›´æ–°**: 2025-11-01
**ç‰ˆæœ¬**: Streaming å„ªåŒ–ç‰ˆ v2.0
**ç‹€æ…‹**: âœ… ç”Ÿç”¢å°±ç·’
