# NPC è¨˜æ†¶ç³»çµ±æ•´åˆç¸½çµ

## âœ… æ•´åˆå®Œæˆ

å·²æˆåŠŸå°‡ `test_memory` åˆ†æ”¯çš„ AI æ™ºèƒ½è¨˜æ†¶ç¯©é¸åŠŸèƒ½æ•´åˆåˆ° `louis_lu` åˆ†æ”¯ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. é•·çŸ­æœŸè¨˜æ†¶åˆ†é›¢
- **çŸ­æœŸè¨˜æ†¶**ï¼šæœ€è¿‘ 7 å¤©çš„æ‰€æœ‰å°è©±ï¼Œæœªç¶“ AI ç¯©é¸
- **é•·æœŸè¨˜æ†¶**ï¼šç¶“ Gemini AI è©•ä¼°ç‚ºé‡è¦çš„å°è©±ï¼Œæ°¸ä¹…ä¿å­˜

### 2. AI æ™ºèƒ½ç¯©é¸
- ä½¿ç”¨ **Gemini 2.5 Flash** æ¨¡å‹è©•ä¼°å°è©±é‡è¦æ€§
- è©•ä¼°ç¶­åº¦ï¼š
  - æƒ…æ„Ÿæ·±åº¦ (aiImportanceScore)
  - æƒ…ç·’å½±éŸ¿ (aiEmotionalImpact)
  - é—œéµè©æå– (aiKeywords)
  - å°è©±æ‘˜è¦ (aiSummary)

### 3. è‡ªå‹•æ­¸æª”æ©Ÿåˆ¶
- æ¯å¤©å‡Œæ™¨ 2 é»è‡ªå‹•åŸ·è¡Œè¨˜æ†¶ç¯©é¸
- æ”¯æ´æ‰‹å‹•è§¸ç™¼ç¯©é¸
- å®Œæ•´æ—¥èªŒè¨˜éŒ„

## ğŸ“ ä¿®æ”¹/æ–°å¢çš„æ–‡ä»¶

### è³‡æ–™åº«å±¤
- âœ… `backend/prisma/schema.prisma` - æ–°å¢é•·æœŸè¨˜æ†¶æ¬„ä½

### Python AI å±¤
- âœ… `backend/memory_filter.py` - AI ç¯©é¸æ ¸å¿ƒé‚è¼¯

### TypeScript æœå‹™å±¤
- âœ… `backend/src/services/npcMemoryService.ts` - æ•´åˆ AI ç¯©é¸æ–¹æ³•
- âœ… `backend/src/services/memoryArchivalScheduler.ts` - å®šæœŸæ­¸æª”èª¿åº¦å™¨

### æ¸¬è©¦èˆ‡æ–‡æª”
- âœ… `backend/test_memory_integration.ts` - æ•´åˆæ¸¬è©¦è…³æœ¬
- âœ… `MEMORY_INTEGRATION_GUIDE.md` - å®Œæ•´ä½¿ç”¨æŒ‡å—
- âœ… `MEMORY_INTEGRATION_SUMMARY.md` - æ•´åˆæ‘˜è¦ï¼ˆæœ¬æ–‡ä»¶ï¼‰

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. å®‰è£ä¾è³´

```bash
cd backend
npm install node-cron
npm install --save-dev @types/node-cron
```

### 2. åŸ·è¡Œè³‡æ–™åº«é·ç§»

```bash
cd backend
npx prisma migrate dev --name add_long_term_memory_fields
npx prisma generate
```

### 3. æ¸¬è©¦æ•´åˆ

```bash
# ç·¨è­¯ TypeScript
npm run build

# åŸ·è¡Œæ¸¬è©¦
npx ts-node test_memory_integration.ts
```

### 4. å•Ÿå‹•èª¿åº¦å™¨ï¼ˆåœ¨ backend/src/index.tsï¼‰

```typescript
import { memoryArchivalScheduler } from './services/memoryArchivalScheduler'

// å•Ÿå‹•è¨˜æ†¶æ­¸æª”èª¿åº¦å™¨
memoryArchivalScheduler.start()
```

## ğŸ“Š æ•´åˆæ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Frontend (React)                        â”‚
â”‚              é¡¯ç¤ºé•·çŸ­æœŸè¨˜æ†¶æ¨™è¨˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ GraphQL Query
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Backend (Node.js/TypeScript)                   â”‚
â”‚   npcMemoryService.ts                                    â”‚
â”‚   - getLongTermMemories()                                â”‚
â”‚   - getShortTermMemories()                               â”‚
â”‚   - filterConversationsWithAI()                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ subprocess call
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Python AI Filter (memory_filter.py)            â”‚
â”‚   - filter_memories_with_ai()                            â”‚
â”‚   - èª¿ç”¨ Gemini CLI                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ Gemini CLI
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Gemini 2.5 Flash API                        â”‚
â”‚   è©•ä¼°å°è©±é‡è¦æ€§ä¸¦è¿”å›ç¯©é¸çµæœ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ è¨˜æ†¶ç”Ÿå‘½é€±æœŸ

```
æ–°å°è©±ç”¢ç”Ÿ
    â†“
å­˜å…¥ Conversation è¡¨ï¼ˆisLongTermMemory = falseï¼‰
    â†“
çŸ­æœŸè¨˜æ†¶ï¼ˆ7 å¤©å…§ï¼‰
    â†“
å®šæœŸèª¿åº¦å™¨è§¸ç™¼ï¼ˆæ¯å¤©å‡Œæ™¨ 2 é»ï¼‰
    â†“
èª¿ç”¨ Python memory_filter.py
    â†“
Gemini AI è©•ä¼°é‡è¦æ€§
    â†“
é‡è¦å°è©± â†’ æ¨™è¨˜ç‚ºé•·æœŸè¨˜æ†¶ï¼ˆisLongTermMemory = trueï¼‰
ä¸é‡è¦å°è©± â†’ ä¿æŒçŸ­æœŸç‹€æ…‹
    â†“
é•·æœŸè¨˜æ†¶æ°¸ä¹…ä¿å­˜ï¼Œç”¨æ–¼æœªä¾†å°è©±ä¸Šä¸‹æ–‡
```

## ğŸ“ˆ é æœŸæ•ˆæœ

### å°è©±å“è³ªæå‡
- NPC èƒ½è¨˜ä½ç©å®¶åˆ†äº«çš„é‡è¦ä¿¡æ¯
- æ·±åº¦å°è©±æœƒè¢«æ°¸ä¹…è¨˜ä½
- æ¸›å°‘é‡è¤‡è©¢å•ç›¸åŒå•é¡Œ

### ç³»çµ±æ€§èƒ½å„ªåŒ–
- è‡ªå‹•æ¸…ç†ä¸é‡è¦çš„æ—¥å¸¸å°è©±
- åªä¿ç•™çœŸæ­£é‡è¦çš„è¨˜æ†¶
- æ¸›å°‘è³‡æ–™åº«è†¨è„¹

### ç©å®¶é«”é©—å¢å¼·
- NPC æ„Ÿè¦ºæ›´"æœ‰è¨˜æ€§"
- é•·æœŸäº’å‹•æ›´æœ‰é€£è²«æ€§
- æƒ…æ„Ÿé€£çµæ›´æ·±åš

## ğŸ¨ èˆ‡ç¾æœ‰ç³»çµ±çš„æ•´åˆ

### èˆ‡ MemoryFlower æ•´åˆ
```typescript
// é•·æœŸè¨˜æ†¶å¯ä»¥è‡ªå‹•ç”Ÿæˆè¨˜æ†¶ä¹‹èŠ±
if (conversation.isLongTermMemory && conversation.aiImportanceScore > 0.7) {
  await createMemoryFlower(conversation)
}
```

### èˆ‡å°è©±ä¸Šä¸‹æ–‡æ•´åˆ
```typescript
// ç”Ÿæˆ NPC å›æ‡‰æ™‚å„ªå…ˆä½¿ç”¨é•·æœŸè¨˜æ†¶
const context = {
  longTermMemories: await npcMemoryService.getLongTermMemories(npcId, userId, 10),
  shortTermMemories: await npcMemoryService.getShortTermMemories(npcId, userId, 7, 20)
}
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

è©³è¦‹ `MEMORY_INTEGRATION_GUIDE.md` ä¸­çš„ã€Œæ•…éšœæ’é™¤ã€ç« ç¯€ã€‚

## ğŸ“š ç›¸é—œæ–‡æª”

1. **MEMORY_INTEGRATION_GUIDE.md** - å®Œæ•´ä½¿ç”¨æŒ‡å—
2. **backend/memory_filter.py** - AI ç¯©é¸å¯¦ç¾
3. **backend/src/services/npcMemoryService.ts** - TypeScript æœå‹™
4. **backend/prisma/schema.prisma** - è³‡æ–™åº« Schema

## ğŸ‘¥ æŠ€è¡“æ”¯æ´

å¦‚æœ‰å•é¡Œï¼Œè«‹åƒè€ƒï¼š
- Gemini CLI æ–‡æª”ï¼š`gemini-cli-docs/`
- Prisma æ–‡æª”ï¼šhttps://www.prisma.io/docs
- Node-cron æ–‡æª”ï¼šhttps://www.npmjs.com/package/node-cron

---

**æ•´åˆå®Œæˆæ™‚é–“**ï¼š2025-08-14
**æ•´åˆåˆ†æ”¯**ï¼šlouis_lu
**ä¾†æºåˆ†æ”¯**ï¼štest_memory
